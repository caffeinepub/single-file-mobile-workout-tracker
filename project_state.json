{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 17,
  "summary": "Workout Generator backend: multiple deployment attempts (v368-375) confirmed to have failed silently — live canister still on broken state (v367 or earlier); unifiedLegsLibrary, useUnifiedLegs toggle, and Text.toLowercase fixes are NOT present in deployed code; new attempt (retry build) underway with four targeted fixes: fix .toLower() → Text.toLowercase() in both filter functions, add unifiedLegsLibrary (17 exercises), add useUnifiedLegs=false toggle, fix adjustRecoveryForTestMode fullyRecoveredTime offset.",
  "architectural_notes": [
    "Backend is Motoko (main.mo) with exercise library + workout generation (generateFullBodyWorkout), recovery state gating, and helpers (buildShuffledSectionFromArrayWithLimit, uniqueByName, calculateRecoveryPercentage).",
    "LegSubgroupRecovery type includes 'legs' field as composite/aggregate recovery value (min/avg of quads/hamstrings/glutes/calves) for dashboard summaries",
    "v366 applied variable substitution (quadsRequestedCount, etc.) but legs still missing due to invalid filter syntax (.toLower() method does not exist on Text) and insufficient test-mode recovery offset",
    "Filter bug: buildShuffledSectionFromArray(WithLimit) uses e.primaryMuscleGroup.toLower() which fails silently → returns 0 exercises for legs",
    "Staged migration strategy: add unifiedLegsLibrary alongside existing exerciseLibrary with useUnifiedLegs toggle; flip toggle in later version to switch generation to unified Legs group without breaking existing logic",
    "Platform deployment pipeline cannot reliably apply surgical edits to existing Motoko backends; breaking changes into smaller additive builds (Build A/B/C) is the preferred workaround",
    "Platform build system confirmed to silently fail and report 'deployed' without updating the canister — live code verified by Grok to still be broken v367 state; no surgical edits have successfully landed since v367"
  ],
  "known_issues": [
    "Imports use mo:core/* instead of mo:base/* (production risk on IC)",
    "uniqueByName uses List.empty() + .add (invalid for immutable List in mo:base/mo:core) → could silently drop exercises",
    "No stable var for Maps → state lost on canister upgrade",
    "No preupgrade/postupgrade hooks → persistence unsafe",
    "Hard-coded magic numbers (3_600_000_000_000, recovery thresholds) should be named constants",
    "Filter syntax bug: buildShuffledSectionFromArray(WithLimit) uses .toLower() method (invalid in Motoko) instead of Text.toLowercase() function → silent failure, returns empty arrays for leg exercises",
    "TEST_RECOVERY_MODE uses fullyRecoveredTime = 0 (epoch) which may not force 100% recovery; should use negative offset (0 - 100*3_600_000_000_000) to guarantee full recovery state"
  ],
  "isFixRequest": true,
  "existing_features": [],
  "new_feature_requests": [
    {
      "id": "AR-2",
      "summary": "Backend production hardening refactor (v362): switch mo:core to mo:base, make persistent state stable, add preupgrade/postupgrade Map serialization, fix recovery math, rewrite uniqueByName using Buffer, dedupe builder functions, normalize muscle group names, move constants to top-level; build.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-5",
      "summary": "Fix filter syntax in buildShuffledSectionFromArray and buildShuffledSectionFromArrayWithLimit: replace Text.equal(e.primaryMuscleGroup.toLower(), group.toLower()) with Text.equal(Text.toLowercase(e.primaryMuscleGroup), Text.toLowercase(group)).",
      "reqIds": [
        "REQ-3"
      ],
      "status": "pending"
    },
    {
      "id": "AR-6",
      "summary": "Force 100% recovery in TEST_RECOVERY_MODE by changing adjustRecoveryForTestMode: set fullyRecoveredTime = 0 - (100 * 3_600_000_000_000) instead of 0.",
      "reqIds": [
        "REQ-4"
      ],
      "status": "pending"
    },
    {
      "id": "AR-7",
      "summary": "In buildShuffledSectionFromArray function in backend/main.mo, replace the invalid filter syntax 'Text.equal(e.primaryMuscleGroup.toLower(), group.toLower())' with 'Text.equal(Text.toLowercase(e.primaryMuscleGroup), Text.toLowercase(group))' to fix the muscle group filtering that is currently returning empty arrays for leg exercises",
      "reqIds": [
        "REQ-5"
      ],
      "status": "pending"
    },
    {
      "id": "AR-8",
      "summary": "In buildShuffledSectionFromArrayWithLimit function in backend/main.mo, replace the invalid filter syntax 'Text.equal(e.primaryMuscleGroup.toLower(), group.toLower())' with 'Text.equal(Text.toLowercase(e.primaryMuscleGroup), Text.toLowercase(group))' to fix the muscle group filtering that is currently returning empty arrays for leg exercises",
      "reqIds": [
        "REQ-6"
      ],
      "status": "pending"
    },
    {
      "id": "AR-9",
      "summary": "In the adjustRecoveryForTestMode function in backend/main.mo, change the line 'let fullyRecoveredTime = 0;' to 'let fullyRecoveredTime = 0 - (100 * 3_600_000_000_000);' to force 100% recovery status for all muscle groups when TEST_RECOVERY_MODE = true",
      "reqIds": [
        "REQ-7"
      ],
      "status": "pending"
    },
    {
      "id": "AR-10",
      "summary": "After deployment, verify that both fixes are present in the deployed backend code: confirm Text.toLowercase is used in both filter functions and fullyRecoveredTime uses the negative offset calculation",
      "reqIds": [
        "REQ-8"
      ],
      "status": "pending"
    },
    {
      "id": "AR-11",
      "summary": "Add unifiedLegsLibrary array (17 exercises all with primaryMuscleGroup='Legs') and useUnifiedLegs=false toggle to main.mo after existing exerciseLibrary, without touching any existing code, arrays, or functions (Version 375 staged migration step).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-12",
      "summary": "Add a new array `unifiedLegsLibrary : [Exercise]` to backend/main.mo positioned AFTER the existing `exerciseLibrary` array. The array must contain exactly these 17 exercises, all with primaryMuscleGroup = \"Legs\" and recoveryTime = 72: Barbell Squats (Barbell), Romanian Deadlifts (Barbell), Bulgarian Split Squats (Dumbbell), Leg Curls (Machine), Leg Extensions (Machine), Hip Thrusts (Barbell), Glute Bridges (Bodyweight), Standing Calf Raises (Machine), Seated Calf Raises (Machine), Goblet Squats (Dumbbell), Walking Lunges (Dumbbell), Stiff-Leg Deadlifts (Barbell), Good Mornings (Barbell), Cable Kickbacks (Cable), Sumo Deadlifts (Barbell), Donkey Calf Raises (Machine), Single-Leg Calf Raises (Bodyweight). Each entry must include the corresponding demoUrl from muscleandstrength.com as specified by the user. Do NOT modify or delete the existing `exerciseLibrary` array or any other existing arrays, types, or functions.",
      "reqIds": [
        "REQ-9"
      ],
      "status": "pending"
    },
    {
      "id": "AR-13",
      "summary": "Add a simple boolean toggle variable `let useUnifiedLegs = false;` to backend/main.mo positioned after the `unifiedLegsLibrary` array declaration. This variable serves as a future migration switch — when set to true it will indicate that workout generation should use `unifiedLegsLibrary` instead of the existing library for leg exercises. For this version it must remain false and must not be referenced by any existing functions.",
      "reqIds": [
        "REQ-10"
      ],
      "status": "pending"
    },
    {
      "id": "AR-14",
      "summary": "In backend/main.mo, fix the invalid filter syntax in the `buildShuffledSectionFromArray` function: replace `Text.equal(e.primaryMuscleGroup.toLower(), group.toLower())` with `Text.equal(Text.toLowercase(e.primaryMuscleGroup), Text.toLowercase(group))`.",
      "reqIds": [
        "REQ-11"
      ],
      "status": "pending"
    },
    {
      "id": "AR-15",
      "summary": "In backend/main.mo, fix the invalid filter syntax in the `buildShuffledSectionFromArrayWithLimit` function: replace `Text.equal(e.primaryMuscleGroup.toLower(), group.toLower())` with `Text.equal(Text.toLowercase(e.primaryMuscleGroup), Text.toLowercase(group))`.",
      "reqIds": [
        "REQ-12"
      ],
      "status": "pending"
    },
    {
      "id": "AR-16",
      "summary": "In backend/main.mo, in the `adjustRecoveryForTestMode` function, change the line `let fullyRecoveredTime = 0;` to `let fullyRecoveredTime = 0 - (100 * 3_600_000_000_000);` so that TEST_RECOVERY_MODE forces 100% recovery for all muscle groups.",
      "reqIds": [
        "REQ-13"
      ],
      "status": "pending"
    },
    {
      "id": "AR-17",
      "summary": "In backend/main.mo, add a `unifiedLegsLibrary : [Exercise]` array positioned immediately after the existing `exerciseLibrary` array. The array must contain exactly these 17 exercises, all with `primaryMuscleGroup = \"Legs\"` and `recoveryTime = 72`: Barbell Squats (Barbell), Romanian Deadlifts (Barbell), Bulgarian Split Squats (Dumbbell), Leg Curls (Machine), Leg Extensions (Machine), Hip Thrusts (Barbell), Glute Bridges (Bodyweight), Standing Calf Raises (Machine), Seated Calf Raises (Machine), Goblet Squats (Dumbbell), Walking Lunges (Dumbbell), Stiff-Leg Deadlifts (Barbell), Good Mornings (Barbell), Cable Kickbacks (Cable), Sumo Deadlifts (Barbell), Donkey Calf Raises (Machine), Single-Leg Calf Raises (Bodyweight). Do NOT modify or delete the existing `exerciseLibrary` array or any other arrays, types, or functions.",
      "reqIds": [
        "REQ-14"
      ],
      "status": "pending"
    },
    {
      "id": "AR-18",
      "summary": "In backend/main.mo, add the boolean toggle `let useUnifiedLegs = false;` immediately after the `unifiedLegsLibrary` array declaration. This variable must remain `false` and must not be referenced or used by any existing functions in this version.",
      "reqIds": [
        "REQ-15"
      ],
      "status": "pending"
    }
  ],
  "gameProjectType": "none",
  "projectName": "Workout Generator",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}