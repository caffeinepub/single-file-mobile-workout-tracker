{
  "kind": "build_request",
  "title": "Fix recovery calculation to unblock leg exercises in Full Body workouts",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "In adjustRecoveryForTestMode, change the fullyRecoveredTime calculation to use a fixed past timestamp (epoch 0 or a timestamp from 365 days ago) instead of Time.now() - offset, so that lastTrained is always in the distant past and recovery always evaluates to 100%",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-final"
        ],
        "quotes": [
          "adjustRecoveryForTestMode uses Time.now() as the base for fullyRecoveredTime. This means lastTrained is set to nearly the current time (minus 100 hours), but because the function runs at generation time, elapsed = Time.now() - lastTrained is very small (milliseconds) → recovery % is near 0% → legs get skipped."
        ]
      },
      "acceptanceCriteria": [
        "adjustRecoveryForTestMode sets lastTrained to a fixed timestamp in the distant past (e.g., 0 or Time.now() - 365*24*3600*1_000_000_000)",
        "All muscle groups including Quads, Hamstrings, Glutes, and Calves consistently evaluate to 100% recovery in test mode",
        "Leg exercises appear in generated Full Body workouts when TEST_RECOVERY_MODE is true"
      ]
    },
    {
      "id": "REQ-2",
      "text": "In calculateRecoveryPercentage, fix the elapsed time calculation to use Time.now() - lastTrained instead of 0 - lastTrained, so that elapsed nanoseconds is computed correctly and recovery percentage is accurate",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-final"
        ],
        "quotes": [
          "Recovery math still uses 0 as 'now' in calculateRecoveryPercentage: elapsedNanos = 0 - lastTrained → wrong base (should be Time.now() - lastTrained)"
        ]
      },
      "acceptanceCriteria": [
        "calculateRecoveryPercentage uses Time.now() as the current time reference",
        "elapsedNanos is computed as Time.now() - lastTrained",
        "Recovery percentages are non-negative and reflect actual time elapsed since last training"
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add debug logging in generateFullBodyWorkout to print the actual size of built sections (quadsSection.size(), hamstringsSection.size(), etc.) after calling buildShuffledSectionFromArrayWithLimit, so filter effectiveness can be verified",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-final"
        ],
        "quotes": [
          "No size logs after building sections in generateFullBodyWorkout: Prints requested count, but not .size() of sections → can't confirm if filter returned exercises"
        ]
      },
      "acceptanceCriteria": [
        "Debug.print statements log the .size() of quadsSection, hamstringsSection, glutesSection, and calvesSection after they are built",
        "Logs appear in the canister console during workout generation",
        "Logs confirm that filtered sections contain the expected number of exercises"
      ]
    }
  ],
  "constraints": [
    "Do not change the backend architecture or introduce multiple actors",
    "Preserve existing frontend immutable paths (useInternetIdentity, useActor, main.tsx, components/ui)",
    "Keep TEST_RECOVERY_MODE = true enabled during this fix",
    "Maintain existing exercise library and workout generation logic structure"
  ],
  "nonGoals": [
    "Refactoring imports from mo:core to mo:base",
    "Rewriting uniqueByName to use Buffer instead of List",
    "Adding stable variables for state persistence",
    "Implementing preupgrade/postupgrade hooks",
    "Extracting hard-coded magic numbers into constants",
    "Frontend UI changes or styling updates"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}