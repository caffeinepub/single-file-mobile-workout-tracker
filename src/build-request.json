{
  "kind": "build_request",
  "title": "Version 364: Backend leg fix-only (case-insensitive group filter + test recovery override)",
  "projectName": "Workout Generator",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "In backend/main.mo, inside the function `buildShuffledSectionFromArrayWithLimit`, replace the existing `groupExercises` filter implementation with the following exact case-insensitive comparison:\n\n```motoko\nlet groupExercises = exercises.filter(func(e) {\n  Text.equal(\n    Text.toLowercase(e.primaryMuscleGroup),\n    Text.toLowercase(group)\n  )\n});\n```",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-USER-V364"
        ],
        "quotes": [
          "In buildShuffledSectionFromArrayWithLimit, replace the filter with:\n\nmotoko\nlet groupExercises = exercises.filter(func(e) {\n  Text.equal(\n    Text.toLowercase(e.primaryMuscleGroup),\n    Text.toLowercase(group)\n  )\n});"
        ]
      },
      "acceptanceCriteria": [
        "`buildShuffledSectionFromArrayWithLimit` compiles and uses `Text.toLowercase(...)` on both `e.primaryMuscleGroup` and `group` and compares via `Text.equal(...)`.",
        "No other logic in `buildShuffledSectionFromArrayWithLimit` is modified beyond replacing the filter block."
      ]
    },
    {
      "id": "REQ-2",
      "text": "In backend/main.mo, replace the entire `adjustRecoveryForTestMode` function with the following exact implementation (including signature) so test mode forces full recovery:\n\n```motoko\nfunc adjustRecoveryForTestMode(_caller : Principal) : RecoveryState {\n  let fullyRecoveredTime = Time.now() - (100 * 3_600_000_000_000);\n  {\n    chest = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    back = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    shoulders = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    arms = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    core = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    quadsRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    hamstringsRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    glutesRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    calvesRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n  };\n}\n```",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-USER-V364"
        ],
        "quotes": [
          "In adjustRecoveryForTestMode, replace the entire function with:\n\nmotoko\nfunc adjustRecoveryForTestMode(_caller : Principal) : RecoveryState {\n  let fullyRecoveredTime = Time.now() - (100 * 3_600_000_000_000);\n  {\n    chest = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    back = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    shoulders = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    arms = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    core = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    quadsRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    hamstringsRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    glutesRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n    calvesRecovery = { lastTrained = fullyRecoveredTime; recoveryPercentage = 100.0 };\n  };\n}"
        ]
      },
      "acceptanceCriteria": [
        "`adjustRecoveryForTestMode` matches the provided code exactly (signature, `Time.now() - (100 * 3_600_000_000_000)`, and all fields set to 100.0).",
        "No other recovery-related functions are changed."
      ]
    },
    {
      "id": "REQ-3",
      "text": "In backend/main.mo, ensure `TEST_RECOVERY_MODE` remains set to `true` (do not change it to false and do not remove it).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-USER-V364"
        ],
        "quotes": [
          "Keep TEST_RECOVERY_MODE = true"
        ]
      },
      "acceptanceCriteria": [
        "`TEST_RECOVERY_MODE` is still present and set to `true` after the changes.",
        "No additional code changes are made beyond REQ-1 and REQ-2."
      ]
    }
  ],
  "constraints": [
    "Modify only backend/main.mo.",
    "Apply only the two requested code changes (filter replacement in `buildShuffledSectionFromArrayWithLimit`, and full replacement of `adjustRecoveryForTestMode`), plus explicitly keeping `TEST_RECOVERY_MODE = true`.",
    "Do not change imports, state variables, other functions, or add new debug logging.",
    "Do not request additional files or clarifications in the implementation workflow."
  ],
  "nonGoals": [
    "Do not perform the previously requested Version 362 refactor (mo:core to mo:base, stable vars, preupgrade/postupgrade, Buffer-based uniqueByName, deduplication of builder functions, moving constants).",
    "Do not modify frontend code."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}