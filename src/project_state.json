{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 7,
  "summary": "Motoko workout-generator backend: case-insensitive filter and debug logging fixed in v363, but legs still missing due to recovery calculation bug in adjustRecoveryForTestMode (uses Time.now() as base → 0% recovery) and calculateRecoveryPercentage (wrong elapsed base); needs recovery math fix to unblock leg exercises.",
  "architectural_notes": [
    "Backend is Motoko (main.mo) with exercise library + workout generation (generateFullBodyWorkout), recovery state gating, and helpers (buildShuffledSectionFromArrayWithLimit, uniqueByName, calculateRecoveryPercentage).",
    "v363 deployed: case-insensitive filter (Text.toLowercase + Text.equal) working, debug prints added for requested counts",
    "Recovery bug confirmed: adjustRecoveryForTestMode sets lastTrained ≈ now → elapsed ≈ 0 → recovery 0% → legs skipped",
    "calculateRecoveryPercentage uses wrong base (0 instead of Time.now()) for elapsed calculation"
  ],
  "known_issues": [
    "adjustRecoveryForTestMode uses Time.now()-based fullyRecoveredTime → lastTrained near current time → elapsed ≈ 0ns → 0% recovery → leg exercises get 0 requested count and are skipped",
    "calculateRecoveryPercentage calculates elapsedNanos as 0 - lastTrained instead of Time.now() - lastTrained, causing negative/zero elapsed → recovery ≤ 0%",
    "No section size logs after building sections in generateFullBodyWorkout → can't confirm if filter returns exercises",
    "Imports use mo:core/* instead of mo:base/* (production risk on IC)",
    "uniqueByName uses List.empty() + .add (invalid for immutable List in mo:base/mo:core) → could silently drop exercises",
    "No stable var for Maps → state lost on canister upgrade",
    "No preupgrade/postupgrade hooks → persistence unsafe",
    "Hard-coded magic numbers (3_600_000_000_000, recovery thresholds) should be named constants"
  ],
  "isFixRequest": true,
  "existing_features": [],
  "new_feature_requests": [
    {
      "id": "AR-2",
      "summary": "Backend production hardening refactor (v362): switch mo:core to mo:base, make persistent state stable, add preupgrade/postupgrade Map serialization, fix recovery math, rewrite uniqueByName using Buffer, dedupe builder functions, normalize muscle group names, move constants to top-level; build.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-9",
      "summary": "Fix adjustRecoveryForTestMode to use a fixed past timestamp (epoch 0 or Time.now() - 365*24*3600*1e9) instead of Time.now()-based calculation, so lastTrained is always in the distant past and recovery is always 100%",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-10",
      "summary": "Fix calculateRecoveryPercentage to use Time.now() - lastTrained for elapsed calculation instead of 0 - lastTrained",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-11",
      "summary": "In adjustRecoveryForTestMode, change the fullyRecoveredTime calculation to use a fixed past timestamp (epoch 0 or a timestamp from 365 days ago) instead of Time.now() - offset, so that lastTrained is always in the distant past and recovery always evaluates to 100%",
      "reqIds": [
        "REQ-1"
      ],
      "status": "pending"
    },
    {
      "id": "AR-12",
      "summary": "In calculateRecoveryPercentage, fix the elapsed time calculation to use Time.now() - lastTrained instead of 0 - lastTrained, so that elapsed nanoseconds is computed correctly and recovery percentage is accurate",
      "reqIds": [
        "REQ-2"
      ],
      "status": "pending"
    },
    {
      "id": "AR-13",
      "summary": "Add debug logging in generateFullBodyWorkout to print the actual size of built sections (quadsSection.size(), hamstringsSection.size(), etc.) after calling buildShuffledSectionFromArrayWithLimit, so filter effectiveness can be verified",
      "reqIds": [
        "REQ-3"
      ],
      "status": "pending"
    }
  ],
  "gameProjectType": "none",
  "projectName": "Workout Generator",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}